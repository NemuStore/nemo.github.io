# ูุฑุงุฌุนุฉ ุดุงููุฉ: ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงููุฑููุช ุฅูุฏ - ุฅุถุงูุฉ ุงูููุชุฌุงุช ูุงููุชุบูุฑุงุช

## ๐ ููุฎุต ุงููุฑุงุฌุนุฉ

ุชูุช ูุฑุงุฌุนุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงููุฑููุช ุฅูุฏ ููุชุฃูุฏ ูู ุฃู ุฌููุน ุงูุตูุฑ ุชูุญูุธ ูู ุฌุฏูู ูุงุญุฏ `product_images` ููุท.

---

## โ ุจููุฉ ุฌุฏูู `product_images`

### ุงูุญููู:
- `id` (UUID, PRIMARY KEY)
- `product_id` (UUID, NOT NULL, FK โ products.id)
- `image_url` (TEXT, NOT NULL) - ุฑุงุจุท ุงูุตูุฑุฉ ูู imgbb
- `display_order` (INTEGER, NOT NULL, DEFAULT 0)
- `is_primary` (BOOLEAN, DEFAULT false)
- `variant_id` (UUID, NULL, FK โ product_variants.id)
  - **NULL** = ุตูุฑุฉ ุนุงูุฉ ููููุชุฌ (ุชุธูุฑ ูุฌููุน ุงููุชุบูุฑุงุช)
  - **UUID** = ุตูุฑุฉ ุฎุงุตุฉ ุจูุชุบูุฑ ูุนูู (ููู/ููุงุณ)
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)

### ุงูููุงุฑุณ:
- `idx_product_images_product_id` - ููุจุญุซ ุงูุณุฑูุน ุญุณุจ ุงูููุชุฌ
- `idx_product_images_display_order` - ูุชุฑุชูุจ ุงูุตูุฑ
- `idx_product_images_variant_id` - ููุจุญุซ ุงูุณุฑูุน ุญุณุจ ุงููุชุบูุฑ
- `idx_product_images_product_variant` - ููุจุญุซ ุงูุณุฑูุน ุญุณุจ ุงูููุชุฌ ูุงููุชุบูุฑ

---

## โ๏ธ ุงููุดููุฉ ุงูุญุงููุฉ: RLS Policies

### ุงููุดููุฉ:
RLS policies ุชุณุชุฎุฏู `auth.uid()` ููุชุญูู ูู ุงููุณุชุฎุฏูุ ููู `auth.uid()` ูุฏ ูุง ูุนูู ุจุดูู ุตุญูุญ ูู Supabase REST API ุญุชู ูุน `Authorization` header.

### ุงูุญู:
ุชู ุฅูุดุงุก ููู `supabase/fix_product_images_rls_final.sql` ุงูุฐู:
1. ูุณุชุฎุฏู `COALESCE(auth.uid(), request.jwt.claims.sub)` ููุชุญูู ูู ุงููุณุชุฎุฏู
2. ูุถูู ุงูุนูู ูุน Supabase client ู REST API
3. ูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุฏูู ุฏูุฑ 'admin' ุฃู 'manager' ูู ุฌุฏูู `users`

### ููููุฉ ุงูุชุทุจูู:
```sql
-- ุชุดุบูู ุงูููู ูู Supabase SQL Editor
-- ุฃู ุงุณุชุฎุฏุงู Supabase CLI:
supabase db execute -f supabase/fix_product_images_rls_final.sql
```

---

## ๐ ูุฑุงุฌุนุฉ ููุฏ ุงููุฑููุช ุฅูุฏ

### 1. ุฏุงูุฉ `addProduct` (ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ)

#### โ ุตูุฑ ุงูููุชุฌ ุงูุนุงูุฉ:
- **ุงููููุน**: `app/(tabs)/admin.tsx` - ุงูุณุทุฑ ~1757-2049
- **ุงูููุทู**:
  1. ุฑูุน ุงูุตูุฑ ุฅูู imgbb API
  2. ุญูุธ ุงูุตูุฑ ูู `product_images` ูุน `variant_id = null`
  3. ุชุนููู `is_primary = true` ููุตูุฑุฉ ุงูุฃููู
  4. ุชุนููู `display_order` ุญุณุจ ุงูุชุฑุชูุจ

#### โ ุตูุฑ ุงููุชุบูุฑุงุช:
- **ุงููููุน**: `app/(tabs)/admin.tsx` - ุงูุณุทุฑ ~2107-2155
- **ุงูููุทู**:
  1. ุฅุถุงูุฉ ุงููุชุบูุฑุงุช ูู `product_variants`
  2. ููู ูุชุบูุฑ ูู `image_url`:
     - ุญูุธ ุงูุตูุฑุฉ ูู `product_images` ูุน `variant_id = UUID`
     - ุชุนููู `is_primary = false`
     - ุชุนููู `display_order = 0`

### 2. ุฏุงูุฉ `updateProduct` (ุชุญุฏูุซ ููุชุฌ ููุฌูุฏ)

#### โ ุตูุฑ ุงูููุชุฌ ุงูุนุงูุฉ:
- **ุงููููุน**: `app/(tabs)/admin.tsx` - ุงูุณุทุฑ ~2541-2735
- **ุงูููุทู**:
  1. ุญุฐู ุงูุตูุฑ ุงููุฏููุฉ ุงูุนุงูุฉ (`variant_id = null`)
  2. ุญูุธ ุงูุตูุฑ ุงูุฌุฏูุฏุฉ ูู `product_images` ูุน `variant_id = null`
  3. ุชุนููู `is_primary = true` ููุตูุฑุฉ ุงูุฃููู
  4. ุชุนููู `display_order` ุญุณุจ ุงูุชุฑุชูุจ

#### โ ุตูุฑ ุงููุชุบูุฑุงุช:
- **ุงููููุน**: `app/(tabs)/admin.tsx` - ุงูุณุทุฑ ~2795-2850 (ุชูุฑูุจุงู)
- **ุงูููุทู**:
  1. ุญุฐู ุงููุชุบูุฑุงุช ุงููุฏููุฉ (ูุชู ุญุฐู ุตูุฑูุง ุชููุงุฆูุงู ุจุณุจุจ `ON DELETE CASCADE`)
  2. ุฅุถุงูุฉ ุงููุชุบูุฑุงุช ุงูุฌุฏูุฏุฉ ูู `product_variants`
  3. ููู ูุชุบูุฑ ูู `image_url`:
     - ุญูุธ ุงูุตูุฑุฉ ูู `product_images` ูุน `variant_id = UUID`
     - ุชุนููู `is_primary = false`
     - ุชุนููู `display_order = 0`

---

## ๐ ููุงุท ุงูุชุญูู

### โ ุชู ุงูุชุญูู:
1. โ ุฌุฏูู `product_images` ูุญุชูู ุนูู `variant_id` column
2. โ ุฌููุน ุงูุตูุฑ (ุนุงูุฉ ููุชุบูุฑุงุช) ุชูุญูุธ ูู `product_images` ููุท
3. โ ุงูุตูุฑ ุงูุนุงูุฉ ููุง `variant_id = null`
4. โ ุตูุฑ ุงููุชุบูุฑุงุช ููุง `variant_id = UUID` (ูุนุฑู ุงููุชุบูุฑ)
5. โ ุงูููุฏ ูุณุชุฎุฏู `fetch` ูุจุงุดุฑุฉ ูุน `Authorization` header
6. โ ุงูููุฏ ูุชุญูู ูู ุตุญุฉ ุงูู token ูุจู ุงูุฅุฏุฑุงุฌ

### โ๏ธ ูุญุชุงุฌ ุฅูู ุฅุตูุงุญ:
1. โ๏ธ RLS policies ุชุญุชุงุฌ ุฅูู ุงูุชุญุฏูุซ ุจุงุณุชุฎุฏุงู `fix_product_images_rls_final.sql`
2. โ๏ธ ูุฏ ุชููู ููุงู ูุดููุฉ ูู `auth.uid()` ูู Supabase REST API

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### 1. ุชุทุจูู ุฅุตูุงุญ RLS Policies:
```bash
# ูู Supabase Dashboard โ SQL Editor
# ุฃู ุงุณุชุฎุฏุงู Supabase CLI:
supabase db execute -f supabase/fix_product_images_rls_final.sql
```

### 2. ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ:
- ุฅุถุงูุฉ ููุชุฌ ูุน ุตูุฑ ุนุงูุฉ
- ุฅุถุงูุฉ ูุชุบูุฑุงุช ูุน ุตูุฑ
- ุงูุชุญูู ูู ุฃู ุฌููุน ุงูุตูุฑ ุชูุญูุธ ูู `product_images`

### 3. ุงุฎุชุจุงุฑ ุชุญุฏูุซ ููุชุฌ ููุฌูุฏ:
- ุชุญุฏูุซ ุตูุฑ ุงูููุชุฌ ุงูุนุงูุฉ
- ุชุญุฏูุซ ุตูุฑ ุงููุชุบูุฑุงุช
- ุงูุชุญูู ูู ุฃู ุงูุชุญุฏูุซุงุช ุชุนูู ุจุดูู ุตุญูุญ

---

## ๐ ุจููุฉ ุงูุจูุงูุงุช ุงูููุงุฆูุฉ

```
products
  โโโ product_images (variant_id = NULL) โ ุตูุฑ ุนุงูุฉ ููููุชุฌ
  โโโ product_variants
        โโโ product_images (variant_id = UUID) โ ุตูุฑ ุฎุงุตุฉ ุจุงููุชุบูุฑ
```

### ูุซุงู:
```
Product: "ูููุต ูุทูู"
โโโ General Images (variant_id = NULL):
โ   โโโ image1.jpg (is_primary = true)
โ   โโโ image2.jpg
โ   โโโ image3.jpg
โโโ Variants:
    โโโ Variant 1: "ุฃุญูุฑ - L"
    โ   โโโ variant_image1.jpg (variant_id = UUID)
    โโโ Variant 2: "ุฃุฒุฑู - M"
        โโโ variant_image2.jpg (variant_id = UUID)
```

---

## ๐ง ููุงุญุธุงุช ุชูููุฉ

1. **imgbb API**: ุฌููุน ุงูุตูุฑ ุชูุฑูุน ุฅูู imgbb API ุฃููุงูุ ุซู ุชูุญูุธ ุงูุฑูุงุจุท ูู `product_images`
2. **RLS Policies**: ูุฌุจ ุฃู ูููู ุงููุณุชุฎุฏู ูุฏูู ุฏูุฑ 'admin' ุฃู 'manager' ูู ุฌุฏูู `users`
3. **CASCADE DELETE**: ุนูุฏ ุญุฐู ููุชุฌ ุฃู ูุชุบูุฑุ ุชูุญุฐู ุตูุฑู ุชููุงุฆูุงู ุจุณุจุจ `ON DELETE CASCADE`
4. **Primary Image**: ููุท ุตูุฑุฉ ูุงุญุฏุฉ ูููู ุฃู ุชููู `is_primary = true` ููู ููุชุฌ/ูุชุบูุฑ (ูุชู ุงูุชุญูู ุจุฐูู ุนุจุฑ trigger)

---

## โ ุงูุฎูุงุตุฉ

ุงูุจููุฉ ุงูุญุงููุฉ ุตุญูุญุฉ:
- โ ุฌููุน ุงูุตูุฑ ุชูุญูุธ ูู `product_images` ููุท
- โ ุงูุตูุฑ ุงูุนุงูุฉ ููุง `variant_id = null`
- โ ุตูุฑ ุงููุชุบูุฑุงุช ููุง `variant_id = UUID`
- โ ุงูููุฏ ูุณุชุฎุฏู `fetch` ูุจุงุดุฑุฉ ูุน `Authorization` header

ุงููุดููุฉ ุงููุญูุฏุฉ:
- โ๏ธ RLS policies ุชุญุชุงุฌ ุฅูู ุงูุชุญุฏูุซ ุจุงุณุชุฎุฏุงู `fix_product_images_rls_final.sql`

ุจุนุฏ ุชุทุจูู ุฅุตูุงุญ RLS policiesุ ูุฌุจ ุฃู ูุนูู ูู ุดูุก ุจุดูู ุตุญูุญ.

